<!DOCTYPE html>
<html lang = "ko">
    <head>
        <meta charset = "UTF-8">
        <style>
            body{
                background:#F8FAFC;
                margin:0px;
                padding:0px;
            }
            h1{
                font-size:20px;
                padding:0px;
                margin:0px;
                margin-top:6px;
                margin-left:12px;
            }
            h2{
                font-size:14px;
                margin:0px;
                padding:0px;
            }
            h3{
                font-size:14px;
                margin:0px;
            }
            .nav{
                display:flex;
                flex-direction: row;
                width: 100%;
                box-sizing: border-box;
                justify-content: space-between;
            }
            #info{
                margin-top:6px;
                margin-bottom:0px;
                margin-right:1px;
            }
            .tmp{
                margin-top:50px;
            }
            .layout{
                display:grid;
                grid-template-columns: repeat(3, 226px);
                gap:88px;
                padding:0px;
                margin-left:94px;
            }
            .notice{
                background : #D9EAFD;
                border-radius:45px;
            }
            .title{
                display:flex;
                justify-content: space-between;
                position: relative;
                width:202px;
                height:25.5px;
                margin-left:20px;
                margin-top:15px;
                margin-bottom:20.5px;
                border-bottom:0.8px solid #225A98;
            }
            .title::after{
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                box-shadow: 0px 4px 4px #00000040;
            }
            .plus{
                width:19px;
                height:19px;
                background-color: transparent;
                border:1.5px solid #3b6ea5;
                border-radius: 50%;
                color: #3b6ea5;
                cursor:pointer;
                display:flex;
                align-items:center;
                justify-content: center;
                padding:0;
                margin-right:33px;
            }
            .plus-icon{
                stroke:#3b6ea5;
                stroke-width:2;
                stroke-linecap:round;
            }
            .plus:active{
                background-color:#3b6ea5;
            }
            
            .plus:active .plus-icon{
                stroke: #D9EAFD;
            }
            .item{
                display:flex;
                flex-direction:row;
                height : 30px;
                width: 160px;
                margin-left:32px;
                margin-top:10px;
            }
            .content{
                display:flex;
                flex-direction:column;
                width:142px;
            }
            .date{
                font-size:10px;
                margin:0px;
                color:#BCCCDC;
            }
            .checkbox{
                width:18px;
                height:18px;
                border-radius: 50%;
                background:#D9EAFD;
                border: 2px solid #3C70A9;
            }
            #todo{
                width:226px;
                height:238px;
            }
            #endtodo{
                width:226px;
                height:333px;
            }
            #notendtodo{
                width:226px;
                height:333px;
            }
            .popup-overlay {
                background: transparent; 
                position: fixed;
                top:0; left:0;right:0 ;bottom:0;
                display: none;
                justify-content: flex-start;
                align-items: flex-start;
                width:100%;
                height: 100%;
                z-index: 1000;
                border : 1px;
            }

            .popup-content {
                background: #F3F9FF;
                margin-top: 46px; margin-left: 257px;
                width:488px;
                height:334px;
                padding: 0px;
                border-radius: 10px;
                border:1px solid #225A98;
            }
            .popup-content form{
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            input[name='title']{
                background-color:#E7F2FF;
                border:1px;
                width:366px;
                height:41px;
            }
            input[name='due_date']{
                background-color:#E7F2FF;
                border:1px;
                width:366px;
                height:41px;    
            }
            #popup-layout1{
                margin-left:49px;
                margin-top:36px;
            }
            #popup-layout2{
                margin-left:49px;
                margin-top:44px;
            }
            .custom{
                position: relative;
                display: inline-block;
                width: 366px;
                background-color: #E7F2FF;
                border: none;
            }
            .custom input[type="date"] {
                appearance: none;
                -webkit-appearance: none;
                -moz-appearance: none;
                background-color: #E7F2FF;
                border: none;
                width: 100%;
                height: 41px;
                padding-right: 30px;
                cursor: pointer;
                opacity: 0;
                /* 날짜는 안 보이지만 달력은 뜨게 */
                color: transparent;
                text-shadow: 0 0 0 #000; /* 포커스 있을 때 날짜 보일 수 있음 */
                position: relative;
                z-index: 2
            }
            .custom input[type="date"]::-webkit-calendar-picker-indicator {
                position: absolute;
                right: 0;
                top: 0;
                width: 100%;
                height: 100%;
                opacity: 0;
                cursor: pointer;
                z-index: 3;
            }
            .custom .custom-icon {
                position: absolute;
                right: 1px;          /* 더 정밀한 위치 */
                top: 50%;
                transform: translateY(-40%);
                pointer-events: none;
                color: #666;
                font-size: 10px;
                z-index: 2;
                color:#225A98;
            }
            
            .popup-buttons{
                display:flex;
                flex-direction: row;
                font-size:11px;
                gap:17px;
                margin-top:67px;
                margin-left:368px;
            }
            .popup-buttons{
                white-space: nowrap;
                width:auto;
            }
            .item-popup-overlay{
                background: transparent; 
                position: fixed;
                top:0; left:0;right:0 ;bottom:0;
                display: none;
                justify-content: flex-start;
                align-items: flex-start;
                width:100%;
                height: 100%;
                z-index: 1000;
                border : 1px;
            }
            .popup-detail .popup-buttons {
                display: flex;
                gap: 5px;
                justify-content: flex-start;
                margin-top: auto;
                margin-left:139px;
            }
            .popup-detail {
                position:relative;
                background: #F8FAFC;
                margin-top:146px;
                margin-left:100px;
                width: 216px;
                height: 265px;
                border-radius: 10px;
                border: 1px solid #8A9197;
                display: flex;
                flex-direction: column;
                gap: 20px;
            }
            .popup-detail input[type="text"],
            .popup-detail input[type="date"] {
                background-color: transparent;
                border: none;
                width: 100%;
                height: 41px;
                padding: 8px;
                font-size: 14px;
            }

            .popup-detail button {
                width: 100px;
                height: 30px;
                background:transparent;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 12px;
            }
            #edit{
                color:#225A98;
            }
            #delete{
                color:#E14C4F;
            }
            #edit:active{
                color:#8A9197;
            }
            #delete:active {
                color: #8A9197;
            }
            .prev-button {
                position:absolute;
                background: none;
                border: none;
                cursor: pointer;
                width: 13px !important;   /* 강제 적용 */
                height: 13px !important;
                padding:0px;
                margin-top:12px;
                margin-left:10px;
            }

            .prev-button svg {
                width: 13px;
                height: 13px;
                stroke: #3B6EA5; /* 원하는 색 */
                display: inline-block;
                vertical-align: middle;
            }
            .To-Do {
                background-color: #3B6EA5; /* 파란색 */
                color: white;
                border-radius: 30px; /* 둥근 원형 느낌 */
                font-weight: 300;
                width: 43px;
                height:17px;
                font-size:10px;
                user-select: none; /* 텍스트 드래그 방지 (선택사항) */
                margin-top:23px;
                margin-left:87px;
                display: flex;
                justify-content: center;    /* 가로 중앙 */
                align-items: center;
            }
            .dot{
                font-size:10px;
                margin-top:25px;
                margin-left:29px;
                color:#3C70A9;
            }
            .dot::before{
                content: "•";              /* 유니코드 동그라미 */
                color: #3B6EA5;            /* 색상 지정 */
                margin-right: 6px;         /* 글자와의 간격 */
                font-size: 12px;           /* 크기 조절 */
                vertical-align: middle;
                top:10px;
            }
            #data-title{
                padding:0px;
                margin-left:29px;
                width:157px;
                font:inter;
            }
            #data-date{
                padding:0px;
                margin-left:33px;
                width:157px;
                font:inter;
            }
            #edit{
                padding:0px;
                width:30px;
            }
            #delete{
                padding:0px;
            }
            .date-display {
                position: absolute;
                top: 0;
                left: 0;
                height: 41px;
                line-height: 41px;
                padding-left: 12px;
                color: #666;
                font-size: 14px;
                z-index: 1;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <div class = 'nav'>
            <h1>To Do List</h1>
            <div>
            <span id = "info">{{ request.user.username }} 님</span>
            <a href="{% url 'main:sign_in' %}" style="margin-left: 8px; color: #3C70A9; text-decoration: none;">/ 로그아웃</a>
            </div>
        </div>
        <div class = 'tmp'>
        <div class = 'layout'>
            <div class="notice" id = "todo">
                <div class = "title">
                    <h2>to do</h2>
                    <button class = "plus" onclick = "openPopup()">
                        <svg class="plus-icon" viewBox="0 0 24 24">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                    </button>
                </div>
                {% for task in todo_tasks %}
                <div class = 'item' onclick = "openItemPopup(this)" data-id = "{{task.id}}" data-title="{{task.title}}" data-date="{{ task.due_date|date:'Y-m-d' }}">
                    <div class = 'content'>
                        <h3>
                            {{task.title}}
                        </h3>
                        <p class = "date">{{task.due_date|date:"Y.m.d"}}까지</p>
                    </div>
                    <button class = "checkbox" data-id="{{ task.id }}"></button>
                </div>
                {% endfor %}
            </div>
            

            <div class="notice" id = "endtodo">
                <div class = "title">
                <h2>end to do</h2>
                </div>
                {% for task in done_tasks %}
                <div class='item' onclick="openItemPopup(this)" data-id="{{task.id}}" data-title="{{task.title}}" data-date="{{ task.due_date|date:'Y-m-d' }}">
                    <div class='content'>
                        <h3>{{ task.title }}</h3>
                        <p class="date">{{ task.due_date|date:"Y.m.d" }}까지</p>
                    </div>
                    <button class="checkbox" data-id="{{ task.id }}"></button>
                </div>
                {% endfor %}
            </div>

            <div class="notice" id = "notendtodo">
                <div class = "title">
                <h2>not end to do</h2>
                </div>
                {% for task in not_done_tasks %}
                <div class='item' onclick="openItemPopup(this)" data-id="{{task.id}}" data-title="{{task.title}}" data-date="{{ task.due_date|date:'Y-m-d' }}">
                    <div class='content'>
                        <h3>{{ task.title }}</h3>
                        <p class="date">{{ task.due_date|date:"Y.m.d" }}까지</p>
                    </div>
                <button class="checkbox" data-id="{{ task.id }}"></button>
            </div>
            {% endfor %}
            </div>
        </div>
        </div>


        <div id="popup" class="popup-overlay" style="display:none;">
            <div class="popup-content">
                <form method="post" action="{% url 'main:add_task' %}">
                    {% csrf_token %}

                    <div id = "popup-layout1">
                    <label for="title">TO DO 입력</label>
                    <input type="text" name="title" required>
                    </div>

                    <div id = "popup-layout2">
                    <label for="due_date">TO DO 기한 설정</label>
                    
                    <div class = "custom">
                    <input type="date" name="due_date" id = "due_date_input" value="" required style = "padding:0px;">
                    <span class="date-display" style="pointer-events:none; color:#666; font-size:14px;"></span>
                    <span class="custom-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </span>
                    </div>
                    
                    </div>

                    <div class="popup-buttons">
                        <button type="button" id = "cancel" onclick="closePopup()" style = "border:none; background: transparent; font-size: 11px; color:#8A9197;">취소</button>
                        <button type="submit" id = "save" style="border:none; background:transparent; font-size: 11px; color:#225A98;">저장 후 닫기</button>
                    </div>
                </form>
            </div>
        </div>


        <div id = "item-popup" class="item-popup-overlay" style = "display: none;">
            <div class = "popup-detail">
                <div>
                    <button class="prev-button" onclick="closeDetailPopup()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="8 5 10 14">
                        <path d="M15 18L9 12L15 6" />
                        </svg>
                    </button>
                    <div class = "To-Do">
                        TO Do
                    </div>
                    <div class="dot">to do</div>
                    <input type="text" id = "data-title"></h2>
                    <div class="dot">기한</div>
                    <input type="date" id = "data-date"></p>
                    <div class = "popup-buttons">
                        <button id = "edit">
                            수정
                        </button>
                        <button id = "delete">
                            삭제
                        </button>
                    </div>
                </div>
            </div>
        </div>





        <div id="delete-confirm-modal" style="display: none;" class="popup-overlay">
            <div style="background: #F8FAFC; border: 1px solid #225A98; width: 316px; height:167px; margin: auto; margin-top: 234px; text-align: left;">
                <p id="delete-message" style="font-size:16px; margin:0px; margin-left:30px; margin-top: 22px; font:Actor;">정말로 삭제하시겠습니까?</p>
                <p id="delete-message2" style="font-size:13px; margin:0px; margin-left:30px; margin-top: 2px; color:#8A9197;">삭제 후에는 복구하기 어렵습니다</p>
                <div style="display: flex; margin-left: 221px;margin-top:60px;">
                    <button id="cancel-delete" style="font-size:11px; padding:0px; color:#8A9197;background:transparent; border: none;">취소</button>
                    <button id="confirm-delete" style="font-size:11px; padding:0px; margin-left: 10px; color:#F34F52; background:transparent; border: none; padding: 5px 12px;">삭제하기</button>
                </div>
            </div>
        </div>

        <script>
            const dateInput = document.getElementById('due_date_input');
            const dateDisplay = document.querySelector('.date-display');

            dateInput.addEventListener('input', () => {
            if (dateInput.value) {
            // 입력값은 yyyy-mm-dd 형식, 보기 좋게 변환 (예: 2025-06-21 -> 2025.06.21)
            const formattedDate = dateInput.value.replace(/-/g, '.');
            dateDisplay.textContent = formattedDate;
            } else {
            dateDisplay.textContent = '날짜 선택';
            }
            });
            function openPopup() {
                document.getElementById("popup").style.display = "flex";
            }

            function closePopup() {
                document.getElementById("popup").style.display = "none";
            }
            function openItemPopup(element) {
                const title = element.dataset.title;
                const date = element.dataset.date;

                document.getElementById("data-title").value = title;
                document.getElementById("data-date").value = date;

                document.getElementById("item-popup").style.display = "flex";

                // 수정/삭제 버튼 이벤트 등록
                const editBtn = document.getElementById("edit");
                const deleteBtn = document.getElementById("delete");

                // 기존 이벤트 제거 (중복 방지)
                editBtn.onclick = null;
                deleteBtn.onclick = null;

                // 수정 버튼 클릭 시 동작 예시
                editBtn.onclick = function () {
                    const newTitle = document.getElementById("data-title").value;
                    const newDate = document.getElementById("data-date").value;
                    const taskId = element.dataset.id;

                    fetch(`/main/edit-task/${taskId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: newTitle,
                            due_date: newDate
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`'${newTitle}' 항목이 수정되었습니다.`);
                            location.reload(); // 또는 수정된 내용을 화면에서 직접 갱신
                        } else {
                            alert('수정에 실패했습니다: ' + (data.error || '알 수 없는 오류'));
                        }
                        closeDetailPopup();
                    });
                };

                deleteBtn.onclick = function () {
                    const taskId = element.dataset.id;
                    const title = element.dataset.title;

                    // 팝업 열기
                    document.getElementById("delete-confirm-modal").style.display = "flex";

                    // 이벤트 중복 방지 위해 기존 핸들러 제거
                    const confirmDeleteBtn = document.getElementById("confirm-delete");
                    const cancelDeleteBtn = document.getElementById("cancel-delete");

                    confirmDeleteBtn.onclick = function () {
                        fetch(`/main/delete-task/${taskId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken'),
                                'Content-Type': 'application/json'
                            },
                        })
                        .then(response => response.json())
                        .then(data => {
                        if (data.success) {
                            alert(`'${title}' 항목이 삭제되었습니다.`);
                            element.remove();
                            closeDetailPopup();
                        } else {
                            alert('삭제에 실패했습니다: ' + (data.error || '알 수 없는 오류'));
                        }
                        document.getElementById("delete-confirm-modal").style.display = "none";
                    });
                };

                cancelDeleteBtn.onclick = function () {
                    document.getElementById("delete-confirm-modal").style.display = "none";
                };
            };

            }
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            function closeDetailPopup() {
                document.getElementById("item-popup").style.display = "none";
            }
            document.querySelectorAll('.checkbox').forEach(btn => {
                btn.addEventListener('click', function (event) {
                    event.stopPropagation();  // item 클릭 이벤트와 겹치지 않게

                    const taskId = btn.dataset.id;

                    fetch(`/main/update-task-status/${taskId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})  // 필요한 정보가 있다면 넣기
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert("할 일이 완료되었습니다.");
                            location.reload();  // 또는 화면에서 해당 item만 제거/이동
                        } else {
                            alert("업데이트 실패: " + data.error);
                        }
                    });
                });
            });
        </script>
    </body>
</html>